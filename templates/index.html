<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnipVault</title>
  
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  
  <style>
    /* Folder Sidebar Styles */
    .main-layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    
    .sidebar {
      width: 250px;
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .sidebar h3 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .folder-list {
      list-style: none;
    }
    
    .folder-item {
      padding: 10px 12px;
      margin-bottom: 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .folder-item:hover {
      background: var(--bg);
    }
    
    .folder-item.active {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    .folder-color {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    
    .folder-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .folder-actions {
      display: none;
      gap: 5px;
    }
    
    .folder-item:hover .folder-actions {
      display: flex;
    }
    
    .folder-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px 5px;
      font-size: 12px;
      opacity: 0.7;
    }
    
    .folder-btn:hover {
      opacity: 1;
    }
    
    .add-folder-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .content-area {
      flex: 1;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--card);
      padding: 30px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal-content h2 {
      margin-bottom: 20px;
    }
    
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }
    
    .color-picker {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.selected {
      border-color: var(--text);
      transform: scale(1.15);
    }
    
    /* Code block styles */
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      padding-bottom: 50px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 12px 0;
      position: relative;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: hidden;
      transition: max-height 0.3s ease;
    }
    
    .code-block.expanded {
      max-height: none;
    }
    
    .code-block pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .code-expand-btn {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--success);
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .code-expand-btn:hover {
      background: #4f46e5;
      transform: translateX(-50%) translateY(-2px);
    }
    
    .code-fade-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(transparent, #1e1e1e);
      pointer-events: none;
      z-index: 1;
    }
    
    .code-block.expanded .code-fade-overlay {
      display: none;
    }
    
    .language-badge {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      margin-bottom: 8px;
      text-transform: uppercase;
      font-weight: bold;
    }
    
    .copy-code-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .copy-code-btn:hover {
      background: #4f46e5;
    }
    
    .copy-code-btn.copied {
      background: var(--success);
    }
    
    .markdown-content {
      line-height: 1.7;
    }
    
    .markdown-content h1 {
      font-size: 1.8em;
      margin: 20px 0 10px 0;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }
    
    .markdown-content h2 {
      font-size: 1.5em;
      margin: 20px 0 10px 0;
    }
    
    .markdown-content h3 {
      font-size: 1.25em;
      margin: 20px 0 10px 0;
    }
    
    .markdown-content ul, .markdown-content ol {
      margin-left: 25px;
      margin-bottom: 15px;
    }
    
    .markdown-content li {
      margin-bottom: 8px;
    }
    
    .markdown-content blockquote {
      border-left: 4px solid var(--primary);
      padding-left: 15px;
      color: var(--muted);
      margin: 15px 0;
      font-style: italic;
    }
    
    .markdown-content p {
      margin-bottom: 12px;
    }
    
    .markdown-content code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
      color: #dc2626;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    
    .snippet-left {
      flex: 1;
    }
    
    /* Drag and Drop Zone */
    .drag-drop-zone {
      border: 3px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s;
      cursor: pointer;
      background: var(--bg);
    }
    
    .drag-drop-zone:hover {
      border-color: var(--primary);
      background: var(--card);
    }
    
    .drag-drop-zone.dragover {
      border-color: var(--success);
      background: #ecfdf5;
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
    }
    
    .drag-drop-zone h3 {
      margin: 0 0 10px 0;
      color: var(--text);
    }
    
    .drag-drop-zone p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    
    .drag-drop-zone .file-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .supported-formats {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .format-badge {
      background: var(--primary);
      color: white;
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
    }
    
    /* Filter Pills */
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .filter-pill {
      display: inline-block;
      padding: 6px 12px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text);
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .filter-pill:hover {
      border-color: var(--primary);
      background: var(--card);
      transform: translateY(-1px);
    }
    
    .filter-pill.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .active-filter {
      display: inline-block;
      padding: 4px 10px;
      background: var(--primary);
      color: white;
      border-radius: 16px;
      font-size: 13px;
      margin-left: 8px;
    }
    
    .active-filter a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    
    /* Search input focus animation */
    #searchInput:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      transform: scale(1.01);
      transition: all 0.2s;
    }
    
    /* Confirm Delete Modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .confirm-modal.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }
    
    .confirm-modal-content {
      background: var(--card);
      padding: 30px;
      border-radius: 16px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      animation: slideIn 0.3s ease;
    }
    
    .confirm-modal-content h2 {
      margin: 0 0 15px 0;
      color: var(--danger);
      font-size: 1.5rem;
    }
    
    .confirm-modal-content p {
      color: var(--muted);
      margin-bottom: 25px;
      line-height: 1.6;
    }
    
    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @media (max-width: 768px) {
      .main-layout {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        position: static;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>✨ SnipVault</h1>
      <p class="subtitle">Save, tag, search and copy text snippets with code formatting & markdown support</p>
    </header>

    <nav class="user-nav">
      {% if current_user.is_authenticated %}
        <div class="user-info">👋 Welcome, <b>{{ current_user.username }}</b></div>
        <a href="{{ url_for('logout') }}" class="btn btn-logout">Logout</a>
      {% else %}
        <a href="{{ url_for('login') }}" class="btn btn-login">Login</a>
        <a href="{{ url_for('signup') }}" class="btn btn-signup">Sign Up</a>
      {% endif %}
    </nav>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flashes">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if current_user.is_authenticated %}
      <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
          <h3>
            📁 Folders
            <button class="add-folder-btn" onclick="openAddFolderModal()">+ New</button>
          </h3>
          
          <ul class="folder-list">
            <li class="folder-item {% if not current_folder %}active{% endif %}">
              <a href="/" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; flex: 1;">
                <span class="folder-color" style="background: #6366f1;"></span>
                <span class="folder-name">All Snippets</span>
              </a>
            </li>
            
            <li class="folder-item {% if current_folder == '0' %}active{% endif %}">
              <a href="/?folder=0" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; flex: 1;">
                <span class="folder-color" style="background: #94a3b8;"></span>
                <span class="folder-name">Uncategorized</span>
              </a>
            </li>
            
            {% for id, name, color in folders %}
            <li class="folder-item {% if current_folder == id|string %}active{% endif %}">
              <a href="/?folder={{ id }}" style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; flex: 1;">
                <span class="folder-color" style="background: {{ color }};"></span>
                <span class="folder-name">{{ name }}</span>
              </a>
              <div class="folder-actions">
                <button class="folder-btn" onclick="openEditFolderModal({{ id }}, '{{ name }}', '{{ color }}')">✏️</button>
                <button class="folder-btn" onclick="confirmDeleteFolder({{ id }}, '{{ name }}')">🗑️</button>
              </div>
            </li>
            {% endfor %}
          </ul>
        </aside>

        <!-- Main Content -->
        <div class="content-area">
          <!-- Drag & Drop Zone -->
          <section class="drag-drop-zone" id="dropZone">
            <div class="file-icon">📁</div>
            <h3>Drag & Drop Files Here</h3>
            <p>Or click to browse files</p>
            <div class="supported-formats">
              <span class="format-badge">.txt</span>
              <span class="format-badge">.md</span>
              <span class="format-badge">.py</span>
              <span class="format-badge">.js</span>
              <span class="format-badge">.json</span>
              <span class="format-badge">.css</span>
              <span class="format-badge">.html</span>
              <span class="format-badge">.sql</span>
            </div>
            <input type="file" id="fileInput" multiple accept=".txt,.md,.py,.js,.json,.css,.html,.sql,.sh,.yaml,.yml,.xml,.java,.cpp,.c,.go,.rs,.rb,.php" style="display: none;">
          </section>
          
          <section class="card">
            <form method="POST" action="/add" class="form-add">
              <textarea name="content" placeholder="Paste code or any text...

💡 Tip: Start with ```language for code blocks
Example:
```python
def hello():
    print('Hello World!')
```" required rows="8"></textarea>
              <div class="form-row">
                <input type="text" name="tag" placeholder="Tag (e.g., python, javascript)">
                <select name="folder_id" style="flex: 1; padding: 12px 14px; border: 2px solid var(--border); border-radius: 8px; font-size: 15px;">
                  <option value="">No Folder</option>
                  {% for id, name, color in folders %}
                  <option value="{{ id }}">📁 {{ name }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn save">💾 Save Snippet</button>
              </div>
            </form>
          </section>

          <section class="search">
            <form method="GET" action="/" class="form-search">
              <input type="text" name="q" id="searchInput" value="{{ q }}" placeholder="🔍 Search snippets, tags, or folders... (Press / to focus)">
              <button type="submit" class="btn clear">Search</button>
              {% if q or current_tag or current_date %}
              <a href="/" class="btn delete" style="text-decoration: none;">Clear</a>
              {% endif %}
            </form>
            
            <!-- Filter Pills -->
            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
              <!-- Tag Filter -->
              {% if tags %}
              <div class="filter-group">
                <label style="font-size: 13px; color: var(--muted); margin-right: 8px;">Tags:</label>
                {% for tag in tags %}
                <a href="/?tag={{ tag }}{% if current_folder %}&folder={{ current_folder }}{% endif %}" 
                   class="filter-pill {% if current_tag == tag %}active{% endif %}">
                  #{{ tag }}
                </a>
                {% endfor %}
              </div>
              {% endif %}
              
              <!-- Date Filter -->
              <div class="filter-group">
                <label style="font-size: 13px; color: var(--muted); margin-right: 8px;">Date:</label>
                <a href="/?date=today{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" 
                   class="filter-pill {% if current_date == 'today' %}active{% endif %}">
                  Today
                </a>
                <a href="/?date=week{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" 
                   class="filter-pill {% if current_date == 'week' %}active{% endif %}">
                  This Week
                </a>
                <a href="/?date=month{% if current_folder %}&folder={{ current_folder }}{% endif %}{% if current_tag %}&tag={{ current_tag }}{% endif %}" 
                   class="filter-pill {% if current_date == 'month' %}active{% endif %}">
                  This Month
                </a>
              </div>
            </div>
            
            <!-- Active Filters Display -->
            {% if current_tag or current_date %}
            <div style="margin-top: 10px; padding: 10px; background: var(--bg); border-radius: 8px; font-size: 14px;">
              <span style="color: var(--muted);">Active filters:</span>
              {% if current_tag %}
              <span class="active-filter">Tag: #{{ current_tag }} <a href="/?{% if current_date %}date={{ current_date }}{% endif %}{% if current_folder %}&folder={{ current_folder }}{% endif %}" style="margin-left: 5px; color: var(--danger);">✕</a></span>
              {% endif %}
              {% if current_date %}
              <span class="active-filter">Date: {{ current_date }} <a href="/?{% if current_tag %}tag={{ current_tag }}{% endif %}{% if current_folder %}&folder={{ current_folder }}{% endif %}" style="margin-left: 5px; color: var(--danger);">✕</a></span>
              {% endif %}
            </div>
            {% endif %}
          </section>

          <section class="list snippets-list">
            {% if q or current_tag or current_date %}
            <div style="padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 15px; font-size: 14px; color: var(--muted);">
              Showing {{ snippets|length }} result{{ 's' if snippets|length != 1 else '' }}
            </div>
            {% endif %}
            
            {% for id, content, tag, folder_id, created_at, last_edited in snippets %}
              <div class="snippet" id="snippet-{{ id }}">
                <div class="snippet-left">
                  <div class="content" id="content-{{ id }}">
                    <div class="snippet-render" data-content="{{ content|e }}"></div>
                  </div>
                  
                  <form method="POST" action="/edit/{{ id }}" class="edit-form" id="edit-form-{{ id }}" style="display:none;">
                    <textarea name="content" class="edit-textarea" rows="10">{{ content }}</textarea>
                    <div class="form-row">
                      <input type="text" name="tag" value="{{ tag or '' }}" placeholder="Tag">
                      <select name="folder_id" style="flex: 1; padding: 12px 14px; border: 2px solid var(--border); border-radius: 8px;">
                        <option value="">No Folder</option>
                        {% for fid, fname, fcolor in folders %}
                        <option value="{{ fid }}" {% if folder_id == fid %}selected{% endif %}>📁 {{ fname }}</option>
                        {% endfor %}
                      </select>
                      <button type="submit" class="btn save">💾 Save</button>
                      <button type="button" class="btn clear cancel-edit" data-id="{{ id }}">Cancel</button>
                    </div>
                  </form>
                  
                  <div class="snippet-meta">
                    {% if tag %}<span class="tag">#{{ tag }}</span>{% endif %}
                    <span class="timestamp">📅 {{ created_at|format_timestamp }}</span>
                    {% if created_at != last_edited %}
                      <span class="timestamp-edited">✏️ edited {{ last_edited|format_timestamp }}</span>
                    {% endif %}
                  </div>
                </div>
                
                <div class="snippet-actions">
                  <button class="btn edit-btn" data-id="{{ id }}">✏️ Edit</button>
                  <button class="btn copy" data-content="{{ content|e }}">📋 Copy</button>
                  <button class="btn delete" onclick="confirmDeleteSnippet({{ id }})">🗑️ Delete</button>
                </div>
              </div>
            {% else %}
              <p class="empty">📭 No snippets yet. Add your first one above!</p>
            {% endfor %}
          </section>
        </div>
      </div>
    {% else %}
      <section class="login-prompt">
        <p class="empty">
          Please <a href="{{ url_for('login') }}">log in</a> or 
          <a href="{{ url_for('signup') }}">create an account</a> to save your snippets.
        </p>
      </section>
    {% endif %}

    <footer class="backend">Backend: <strong>Flask + SQLite</strong></footer>
    <footer>made with ❤️ by <b>Juben Mehta</b></footer>
  </div>

  <!-- Add Folder Modal -->
  <div class="modal" id="addFolderModal">
    <div class="modal-content">
      <h2>Create New Folder</h2>
      <form method="POST" action="/folders/create">
        <input type="text" name="name" placeholder="Folder name" required style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
        
        <div class="color-picker">
          <div class="color-option selected" style="background: #6366f1;" data-color="#6366f1"></div>
          <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
          <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
          <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
          <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
          <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
        </div>
        
        <input type="hidden" name="color" id="folderColor" value="#6366f1">
        
        <div class="modal-actions">
          <button type="button" class="btn clear" onclick="closeAddFolderModal()">Cancel</button>
          <button type="submit" class="btn save">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Folder Modal -->
  <div class="modal" id="editFolderModal">
    <div class="modal-content">
      <h2>Edit Folder</h2>
      <form method="POST" id="editFolderForm">
        <input type="text" name="name" id="editFolderName" placeholder="Folder name" required style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; margin-bottom: 10px;">
        
        <div class="color-picker" id="editColorPicker">
          <div class="color-option" style="background: #6366f1;" data-color="#6366f1"></div>
          <div class="color-option" style="background: #10b981;" data-color="#10b981"></div>
          <div class="color-option" style="background: #f59e0b;" data-color="#f59e0b"></div>
          <div class="color-option" style="background: #ef4444;" data-color="#ef4444"></div>
          <div class="color-option" style="background: #8b5cf6;" data-color="#8b5cf6"></div>
          <div class="color-option" style="background: #ec4899;" data-color="#ec4899"></div>
        </div>
        
        <input type="hidden" name="color" id="editFolderColor">
        
        <div class="modal-actions">
          <button type="button" class="btn clear" onclick="closeEditFolderModal()">Cancel</button>
          <button type="submit" class="btn save">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-content">
      <h2>⚠️ Confirm Delete</h2>
      <p id="confirmMessage">Are you sure you want to delete this?</p>
      <div class="confirm-actions">
        <button type="button" class="btn clear" onclick="closeConfirmModal()">Cancel</button>
        <button type="button" class="btn delete" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <!-- Hidden forms for deletion -->
  <form id="deleteFolderForm" method="POST" style="display:none;"></form>
  <form id="deleteSnippetForm" method="POST" style="display:none;"></form>

  <script>
    // File extension to language mapping
    const extensionToLanguage = {
      'py': 'python',
      'js': 'javascript',
      'json': 'json',
      'html': 'html',
      'css': 'css',
      'md': 'markdown',
      'sql': 'sql',
      'sh': 'bash',
      'yaml': 'yaml',
      'yml': 'yaml',
      'xml': 'xml',
      'java': 'java',
      'cpp': 'cpp',
      'c': 'c',
      'go': 'go',
      'rs': 'rust',
      'rb': 'ruby',
      'php': 'php',
      'txt': 'text'
    };
    
    // Drag and Drop functionality
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    // Highlight drop zone when dragging over
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight(e) {
      dropZone.classList.add('dragover');
    }
    
    function unhighlight(e) {
      dropZone.classList.remove('dragover');
    }
    
    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }
    
    // Click to browse
    dropZone.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    
    async function handleFiles(files) {
      const fileArray = [...files];
      
      for (const file of fileArray) {
        // Check file size (max 1MB)
        if (file.size > 1024 * 1024) {
          alert(`File ${file.name} is too large (max 1MB)`);
          continue;
        }
        
        try {
          const content = await readFileContent(file);
          const extension = file.name.split('.').pop().toLowerCase();
          const language = extensionToLanguage[extension] || 'text';
          const tag = extension !== 'txt' ? extension : '';
          
          // Create snippet with code block formatting
          let snippetContent = content;
          if (language !== 'text') {
            snippetContent = '```' + language + '\n' + content + '\n```';
          }
          
          // Auto-submit to create snippet
          await createSnippetFromFile(snippetContent, tag, file.name);
          
        } catch (error) {
          console.error('Error reading file:', error);
          alert(`Error reading file ${file.name}`);
        }
      }
      
      // Reset file input
      fileInput.value = '';
    }
    
    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
      });
    }
    
    async function createSnippetFromFile(content, tag, filename) {
      try {
        const formData = new FormData();
        formData.append('content', content);
        formData.append('tag', tag);
        
        const response = await fetch('/add', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          // Show success message
          showNotification(`✅ ${filename} imported successfully!`, 'success');
          
          // Reload page after a short delay
          setTimeout(() => window.location.reload(), 1000);
        } else {
          throw new Error('Failed to create snippet');
        }
      } catch (error) {
        console.error('Error creating snippet:', error);
        showNotification(`❌ Failed to import ${filename}`, 'error');
      }
    }
    
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = 'flash ' + type;
      notification.textContent = message;
      notification.style.position = 'fixed';
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.zIndex = '9999';
      notification.style.animation = 'slideIn 0.3s ease';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Confirmation modal state
    let pendingDeleteAction = null;
    
    function openConfirmModal(message, action) {
      document.getElementById('confirmMessage').textContent = message;
      document.getElementById('confirmModal').classList.add('active');
      pendingDeleteAction = action;
    }
    
    function closeConfirmModal() {
      document.getElementById('confirmModal').classList.remove('active');
      pendingDeleteAction = null;
    }
    
    function confirmDeleteFolder(folderId, folderName) {
      openConfirmModal(
        `Are you sure you want to delete "${folderName}"? Snippets in this folder will become uncategorized.`,
        function() {
          const form = document.getElementById('deleteFolderForm');
          form.action = '/folders/' + folderId + '/delete';
          form.submit();
        }
      );
    }
    
    function confirmDeleteSnippet(snippetId) {
      openConfirmModal(
        'Are you sure you want to delete this snippet? This action cannot be undone.',
        function() {
          const form = document.getElementById('deleteSnippetForm');
          form.action = '/delete/' + snippetId;
          form.submit();
        }
      );
    }
    
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
      if (pendingDeleteAction) {
        pendingDeleteAction();
      }
      closeConfirmModal();
    });
    
    // Folder modals
    function openAddFolderModal() {
      document.getElementById('addFolderModal').classList.add('active');
    }
    
    function closeAddFolderModal() {
      document.getElementById('addFolderModal').classList.remove('active');
    }
    
    function openEditFolderModal(id, name, color) {
      document.getElementById('editFolderModal').classList.add('active');
      document.getElementById('editFolderName').value = name;
      document.getElementById('editFolderColor').value = color;
      document.getElementById('editFolderForm').action = '/folders/' + id + '/edit';
      
      // Set selected color
      document.querySelectorAll('#editColorPicker .color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.getAttribute('data-color') === color) {
          opt.classList.add('selected');
        }
      });
    }
    
    function closeEditFolderModal() {
      document.getElementById('editFolderModal').classList.remove('active');
    }
    
    // Color picker
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', function() {
        const picker = this.parentElement;
        picker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        
        const colorInput = picker.parentElement.querySelector('input[type="hidden"]');
        colorInput.value = this.getAttribute('data-color');
      });
    });
    
    // Close modals on outside click
    document.querySelectorAll('.modal, .confirm-modal').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          this.classList.remove('active');
        }
      });
    });

    // Markdown parser
    function parseSimpleMarkdown(text) {
      text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>');
      text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
      text = text.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
      text = text.replace(/^\- (.*$)/gim, '<li>$1</li>');
      text = text.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
      text = text.replace(/\n\n/g, '</p><p>');
      text = '<p>' + text + '</p>';
      text = text.replace(/<p><\/p>/g, '');
      return text;
    }

    function isCodeBlock(text) {
      return text.trim().startsWith('```');
    }

    function extractCodeBlock(text) {
      const match = text.match(/^```(\w+)?\n([\s\S]*?)\n```$/);
      if (match) {
        return { language: match[1] || 'text', code: match[2] };
      }
      return null;
    }

    function looksLikeCode(text) {
      const codePatterns = /^(function|const|let|var|def|class|import|from|SELECT|INSERT|UPDATE|DELETE)/m;
      const symbolCount = (text.match(/[{}\[\]();=>]/g) || []).length;
      return codePatterns.test(text) || symbolCount > 5;
    }

    function addCopyButton(container, code) {
      const button = document.createElement('button');
      button.className = 'copy-code-btn';
      button.textContent = '📋 Copy';
      button.onclick = function(e) {
        e.stopPropagation();
        navigator.clipboard.writeText(code).then(() => {
          button.textContent = '✅ Copied!';
          button.classList.add('copied');
          setTimeout(() => {
            button.textContent = '📋 Copy';
            button.classList.remove('copied');
          }, 2000);
        });
      };
      container.appendChild(button);
    }
    
    function addExpandButton(container) {
      const pre = container.querySelector('pre');
      if (!pre) {
        console.log('No pre element found');
        return;
      }
      
      const lineCount = pre.textContent.split('\n').length;
      console.log('Line count:', lineCount);
      
      // Only add expand button if content is long (more than 15 lines)
      if (lineCount > 15) {
        console.log('Adding expand button');
        
        const fadeOverlay = document.createElement('div');
        fadeOverlay.className = 'code-fade-overlay';
        container.appendChild(fadeOverlay);
        
        const expandBtn = document.createElement('button');
        expandBtn.className = 'code-expand-btn';
        expandBtn.textContent = '▼ Show More';
        
        expandBtn.onclick = function(e) {
          e.stopPropagation();
          if (container.classList.contains('expanded')) {
            container.classList.remove('expanded');
            expandBtn.textContent = '▼ Show More';
            container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          } else {
            container.classList.add('expanded');
            expandBtn.textContent = '▲ Show Less';
          }
        };
        
        container.appendChild(expandBtn);
      } else {
        console.log('Not enough lines, skipping expand button');
      }
    }

    function renderSnippet(element) {
      const content = element.getAttribute('data-content');
      element.innerHTML = '';
      
      const codeBlock = extractCodeBlock(content);
      if (codeBlock) {
        if (codeBlock.language !== 'text') {
          const badge = document.createElement('span');
          badge.className = 'language-badge';
          badge.textContent = codeBlock.language;
          element.appendChild(badge);
        }
        
        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-block';
        const pre = document.createElement('pre');
        pre.textContent = codeBlock.code;
        codeContainer.appendChild(pre);
        addCopyButton(codeContainer, codeBlock.code);
        element.appendChild(codeContainer);
      } else if (looksLikeCode(content)) {
        const codeContainer = document.createElement('div');
        codeContainer.className = 'code-block';
        const pre = document.createElement('pre');
        pre.textContent = content;
        codeContainer.appendChild(pre);
        addCopyButton(codeContainer, content);
        element.appendChild(codeContainer);
      } else {
        const markdownDiv = document.createElement('div');
        markdownDiv.className = 'markdown-content';
        markdownDiv.innerHTML = parseSimpleMarkdown(content);
        element.appendChild(markdownDiv);
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('copy')) {
        const content = e.target.getAttribute('data-content');
        navigator.clipboard.writeText(content).then(() => {
          const originalText = e.target.innerHTML;
          e.target.innerHTML = '✅ Copied!';
          e.target.style.background = 'var(--success)';
          setTimeout(() => {
            e.target.innerHTML = originalText;
            e.target.style.background = '';
          }, 2000);
        });
      }
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        document.getElementById('content-' + id).style.display = 'none';
        document.getElementById('edit-form-' + id).style.display = 'block';
      });
    });

    document.querySelectorAll('.cancel-edit').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        document.getElementById('content-' + id).style.display = 'block';
        document.getElementById('edit-form-' + id).style.display = 'none';
      });
    });

    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.snippet-render').forEach(renderSnippet);
    });
  </script>
</body>
</html>
